---
#
# Copyright (C) 2019 Geon Technologies, LLC
#
# This file is part of FINS.
#
# FINS is free software: you can redistribute it and/or modify it under the
# terms of the GNU Lesser General Public License as published by the Free
# Software Foundation, either version 3 of the License, or (at your option)
# any later version.
#
# FINS is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License for
# more details.
#
# You should have received a copy of the GNU Lesser General Public License
# along with this program.  If not, see http://www.gnu.org/licenses/.
#

variables:
    VIVADO_VERSION: '2019.1'
    QUARTUS_VERSION: '19.1'
stages:
    - test
    - package
test:
    stage: test
    before_script:
        - 'yum install -y epel-release'
        - 'yum install -y python36 python36-pip python-jinja2 octave make gcc glibc.i686'
        - 'python3 -m pip install --upgrade pip setuptools'
        - 'python3 -m pip install .'
        - 'python3 -m pip install ./vivado'
        - 'python3 -m pip install ./quartus'
    script:
        #- 'source /opt/fpga/Xilinx/Vivado/$VIVADO_VERSION/settings64.sh'
        - 'export PATH=$PATH:/opt/fpga/Intel/intelFPGA_pro/$QUARTUS_VERSION/quartus/bin:/opt/fpga/Intel/intelFPGA_pro/$QUARTUS_VERSION/modelsim_ase/bin:/opt/fpga/Intel/intelFPGA_pro/$QUARTUS_VERSION/qsys/bin'
        - 'cd test/node'
        #- 'fins -b vivado fins.json && make sim && make clean-all'
        - 'fins -b quartus fins.json && make sim && make clean-all'
        - 'cd ../../test/nodeset'
        - 'fins nodeset.json'
        - 'cd ../../tutorials/power_converter'
        #- 'fins -b vivado fins.json && make sim && make clean-all'
        - 'fins -b quartus fins.json && make sim && make clean-all'
    tags:
        - QuartusPrimePro

rpmbuild:
    stage: package
    image: centos:7
    before_script:
        - yum install -y epel-release rpm-build rpmdevtools
        - yum install -y python3 python3-pip
        - python3 -m pip install --user -U pip setuptools
        # Create build tree; can't rely on bdist_rpm
        - rpmdev-setuptree
        # Neutralize brp-python-bytecompile
        - sed -i '2iexit 0' /usr/lib/rpm/brp-python-bytecompile
    script:
        - python3 setup.py bdist_rpm --spec-only
        - mv dist/*.spec ~/rpmbuild/SPECS/
        - cd ~/rpmbuild/SPECS
        # Patch spec file
        - sed -i 's/-O1/--no-compile/g' *.spec && cd ~/rpmbuild
        # tarball sources
        - >-
          export NAME=`grep "define name" ~/rpmbuild/SPECS/*.spec |
          cut -d" " -f 3`
        - >-
          export VER=`grep "define version" ~/rpmbuild/SPECS/*.spec |
          cut -d" " -f 3`
        - cd $CI_PROJECT_DIR
        - cp -R . "/tmp/$NAME-$VER"
        - cd /tmp
        - >-
          tar -czvf
          ~/rpmbuild/SOURCES/$NAME-$VER.tar.gz --exclude='.rrpucs-gitlab-ci.yml'
          $NAME-$VER
        # Build RPM old-fashioned way
        - cd ~/rpmbuild
        - rpmbuild -bb SPECS/*.spec
        - mv RPMS/noarch/*.rpm $CI_PROJECT_DIR/dist/
    after_script:
        # Remove build tree
        - rm -rf ~/rpmbuild
        - rm -rf /tmp/$NAME-$VER
        # Restore brp-python-bytecompile
        - sed -i '2d' /usr/lib/rpm/brp-python-bytecompile
    artifacts:
        paths:
            - dist/*.rpm
    rules:
        - if: '$CI_COMMIT_BRANCH == "rrpucs"'
